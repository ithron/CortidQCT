<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>CortidQCT: Corid-QCT [![Build Status](https://travis-ci.com/ithron/CortidQCT.svg?token=sHAjhRB8BYK3KqcS7UsE&amp;branch=master)](https://travis-ci.com/ithron/CortidQCT) [![Build status](https://ci.appveyor.com/api/projects/status/gkajxg953p5ny1gp/branch/master?svg=true)](https://ci.appveyor.com/project/ithron/cortidqct/branch/master)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CortidQCT
   &#160;<span id="projectnumber">1.2.2.45</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Corid-QCT [![Build Status](<a href="https://travis-ci.com/ithron/CortidQCT.svg?token=sHAjhRB8BYK3KqcS7UsE&branch=master">https://travis-ci.com/ithron/CortidQCT.svg?token=sHAjhRB8BYK3KqcS7UsE&amp;branch=master</a>)](<a href="https://travis-ci.com/ithron/CortidQCT">https://travis-ci.com/ithron/CortidQCT</a>) [![Build status](<a href="https://ci.appveyor.com/api/projects/status/gkajxg953p5ny1gp/branch/master?svg=true">https://ci.appveyor.com/api/projects/status/gkajxg953p5ny1gp/branch/master?svg=true</a>)](<a href="https://ci.appveyor.com/project/ithron/cortidqct/branch/master">https://ci.appveyor.com/project/ithron/cortidqct/branch/master</a>) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A tool for automatic cortical shape identification for QCT scans.</p>
<p>This software is based on "Reinhold S. et al. (2019) [**An Analysis by Synthesis Approach for Automatic Vertebral Shape Identification in Clinical QCT**](https://doi.org/10.1007/978-3-030-12939-2_6). In: Brox T., Bruhn A., Fritz M. (eds) Pattern Recognition. GCPR 2018. Lecture Notes in Computer Science, vol 11269. Springer, Cham." (<a href="https://doi.org/10.1007/978-3-030-12939-2_6">Full article</a>, <a href="https://arxiv.org/abs/1812.00693">preprint</a>)</p>
<h2>Binary Releases</h2>
<p>The current release is <b>v1.2.2</b>:</p>
<ul>
<li><a href="https://github.com/ithron/CortidQCT/releases/download/v1.2.2/CortidQCT-v1.2.2-win64.zip">CortidQCT-v1.2.2-win64.zip</a> Windows x64 binary release</li>
<li><a href="https://github.com/ithron/CortidQCT/releases/download/v1.2.2/CortidQCT-v1.2.2-macOS-Mojave.zip">CortidQCT-v1.2.2-macOS-Mojave.zip</a> macOS Mojave binary release</li>
<li><a href="https://github.com/ithron/CortidQCT/releases/download/v1.2.2/CortidQCT-v1.2.2-x86_64-linux-gnu-ubuntu-18.04.tar.gz">CortidQCT-v1.2.2-x86_64-linux-gnu-ubuntu-18.04.tar.gz</a> Ubuntu Linux 18.04 x86_64 binary release</li>
<li><a href="https://github.com/ithron/CortidQCT/releases/download/v1.2.2/CortidQCT-v1.2.2.mltbx">CortidQCT-v1.2.2.mltbx</a> MATLAB toolbox</li>
</ul>
<p>Older releases can be found <a href="https://github.com/ithron/CortidQCT/releases">here</a>.</p>
<h2>Build from Source</h2>
<p>The build instructions below are for *NIX (Unix/Linux/macOS) systems only. For Windows build, the configuration steps (1 to 4) should be the same, but the compilation step might be different, dependent on the compiler used.</p>
<h3>C++ Library</h3>
<h4>Requirements</h4>
<ul>
<li><em>cmake</em> version 3.9 or newer</li>
<li>A modern C++ compiler with C++17 support is required. These compilers are known to work:<ul>
<li>gcc: version 7.3 or later</li>
<li>clang:<ul>
<li>version 4.0 or later (with libc++ or stdlibc++-7.3 or later)</li>
<li>on Windows: version 7.0 with Visual Studio 2017 or later</li>
</ul>
</li>
<li>AppleClang: version 10.0 or later (Xcode 10, since macOS 10.4 Mojave)</li>
<li>~~MSVC++: version 14.1 or later (Visual Studio 2017 version 15.0 or later)~~ <span style="color:red">Due to a compiler bug MSVC 14.1 does currently not work</span></li>
</ul>
</li>
</ul>
<h4>Building</h4>
<p><em><a class="el" href="namespaceCortidQCT.html" title="Name namespace for CortidQCT library. ">CortidQCT</a></em> uses the <a href="https://hunter.sh">Hunter</a> package manager to manage its dependencies. Therefore, it's not required to manually install any dependecies. Hunter builds and installs all dependencies automatically in the <code>${HOME}/.hunter</code> directory. This can be changed by setting the <code>HUNTER_ROOT</code> environment variable.</p>
<p>It is strongly recommended to install <a class="el" href="namespaceCortidQCT.html" title="Name namespace for CortidQCT library. ">CortidQCT</a> to a custom location. For this, set the <code>CortidQCT_ROOT</code> environment to the desired path.</p>
<ol type="1">
<li>Clone the repository: <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;git clone htts://github.com/ithron/CortidQCT.git</div></div><!-- fragment --></li>
<li>Init the submodules: <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;cd CortidQCT</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;git submodule update --init</div></div><!-- fragment --></li>
<li>Create build directory <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;mkdir Build</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;cd build</div></div><!-- fragment --></li>
<li>Run <code>cmake</code> <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;cmake -DCMAKE_INSTALL_PREFIX=${CortidQCT_ROOT} -DCMAKE_BUILD_TYPE=Release ../</div></div><!-- fragment --></li>
<li>Run <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;make</div></div><!-- fragment --></li>
<li>installation <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;make install</div></div><!-- fragment --></li>
</ol>
<h3>MATLAB Toolbox</h3>
<h4>Requirements</h4>
<ul>
<li>MATLAB R2017b or later</li>
<li>Parallel Computing Toolbox</li>
<li>Statistics Toolbox</li>
<li>A CUDA compatible GPU</li>
<li>CUDA drivers</li>
</ul>
<h4>Installation</h4>
<p>Navigate to the installation folder in MATLAB, then open <code>matlab/CortidQCT.prj</code>. This opens the toolbox packaging dialog. Click 'Package' and close the dialog. Double click the new file <code>CortidQCT.mltbx</code> to install the toolbox.</p>
<h2>Usage</h2>
<p>Using <em><a class="el" href="namespaceCortidQCT.html" title="Name namespace for CortidQCT library. ">CortidQCT</a></em> is a two step process. First a model for each different protocol must be generated using the MATLAB toolbox. After that, either the <em>command line interface (CLI)</em> tool, the <em>C+++ library</em> or the MATLAB interface can be used to identify the cortex using the generated model.</p>
<h2>Model Creation</h2>
<table class="doxtable">
<tr>
<th align="center"><div class="image">
<img src="images/ModelCreation-Screenshot1.png"  alt="Model Creation Screen 1"/>
</div>
 </th><th align="center"><div class="image">
<img src="images/ModelCreation-Screenshot2.png"  alt="Model Creation Screen 2"/>
</div>
  </th></tr>
<tr>
<td align="center">General model parameters dialog </td><td align="center">Per VOI parameters dialog </td></tr>
</table>
<p>In MATLAB run </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;CortidQCT.CreateModel</div></div><!-- fragment --><p> to start the model creation UI. On the first screen (general tab, see left screenshot above) meta and general information about the model can be entered. In the VOIs tab (see right screenshot above), per VOI prior parameters can be entered. Ensure that each VOI gets an unique label. Since the interpretation of the parameters of log-normally distributed cortex width parameter is not very intuituve, a plot of the current PDF is plotted in the bottom right. The red shaded region shows the 95% confidence interval.</p>
<p>After specifying all VOIs, click the <em>Generate Model</em> button start start the generation process. Depending on the hardware, this process may take a while. When the model generation completed, a green <em>Save Model</em> button will appear. Ensure to save the model before quitting the dialog.</p>
<h2>Cortex Identification</h2>
<p>You can either write your own program that uses the <em>C++ library</em>, use the built-in CLI tool or use the MATLAB interface that comes with the toolbox.</p>
<h3>Command Line interface</h3>
<p>After compilation the <code>CortidQCT_CLI</code> executable can be found in <code>build/app</code>. It requires at least three parameters:</p><ol type="1">
<li>A YAML configuration file</li>
<li>The input volume / scan</li>
<li>Path to the output mesh file</li>
<li><em>Optional: Path to a file where to write the per-vertex labels to</em></li>
</ol>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;app/CortidQCT_CLI &lt;configurationFile&gt; &lt;inputVolume&gt; &lt;outputMesh&gt; [outputLabels]</div></div><!-- fragment --><h3>C++ Library</h3>
<p>The <a href="https://ithron.github.io/CortidQCT/html/index.html">API Reference</a> can be found <a href="https://ithron.github.io/CortidQCT/html/index.html">here</a>.</p>
<h3>C Bindings</h3>
<p>Available since Version v1.1.0. See the <code>C-Bindings</code> module in the <a href="https://ithron.github.io/CortidQCT/html/index.html">API Reference</a> for details. An example can be found in <code><a class="el" href="cli_8c.html" title="This file contains an example C only implementation of the CLI to CortidQCT. ">bindings/C/examples/cli.c</a></code>.</p>
<h3>Matlab Interface</h3>
<p>Since version 1.2.0 <a class="el" href="namespaceCortidQCT.html" title="Name namespace for CortidQCT library. ">CortidQCT</a> also has MATLAB bindings, enabling the direct interaction with the library from within MATLAB.</p>
<p>An example implementation of the CLI interface can be found in <code>examples/CortidQCT_cli.m</code>: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;function [resultMesh, volume] = CortidQCT_cli(configFilename, volumeFilename, outputMeshFilename, varargin)</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;%CORTIDQCT-CLI Identifies the cortical shape of the given volume and writes</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;%the output to the given file</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;import CortidQCT.lib.*;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;% Load volume</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;volume = VoxelVolume.fromFile(volumeFilename);</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;% Create MeshFitter using config file</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;fitter = MeshFitter(configFilename);</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;% fit</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;result = fitter.fit(volume);</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;% write output</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;result.mesh.writeToFile(outputMeshFilename, varargin{:});</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;% plot results</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;volume.plot;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;hold on;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;h = result.mesh.plot;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;axis equal</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;colormap gray</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;h.FaceColor = &#39;g&#39;;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;h.FaceAlpha = 0.3;</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;resultMesh = result.mesh;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;end</div></div><!-- fragment --><p> This function mimics the CLI application with additional visualization of the result: </p>
<div class="image">
<img src="images/matlab-example-output.gif"  alt="Example matlab plot"/>
</div>
<h3>Configuration File</h3>
<p>The main purpose of the configuration file is to specify the reference mesh and the model file. Additionally some parameters can be customized. The configuration file must be in the <a href="http://yaml.org/start.html">YAML</a> format.</p>
<h4>Reference mesh</h4>
<p>The following snippet defines a refernece mesh <code>path/to/reference/mesh.coff</code> consisting of a colored <code>object file format</code> mesh. Here each vertex color corresponds to a model label. The mapping is defined in the <code>colorToLabelMap</code> section. The custom mapping is supplied in the <code>map</code> section. Each element must be a two element list that contains a three element list and a single ineteger label: <code>[[R, G, B], Label]</code>.</p>
<p>The <code>origin: centerd</code> parameter states that the centroid of the reference mesh should be moved into the center of the image, which is the default behaviour. </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;referenceMesh:</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  mesh: path/to/refernce/mesh.coff</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  colorToLabelMap:</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    type: custom</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    map:</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;      - [[255, 0, 0], 1]¬</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;      - [[0, 255, 0], 0]¬</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;      - [[255, 255, 0], 2]¬</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;      - [[0, 0, 255], 3]¬</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    undefinedLabel: 4</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;  origin: centered</div></div><!-- fragment --><p> If a relative path is given, it is interpreted as relative to the configuration file.</p>
<h4>Measurement Model</h4>
<p>The measurement model is specified by the path to the previously generated model file: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;measurementModel: path/to/my/model.yml</div></div><!-- fragment --><p> If a relative path is given, it is interpreted as relative to the configuration file.</p>
<h4>Optimization Parameters</h4>
<p>There are several optional parameters that can be tuned: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;sigmaE: 5.4</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;sigmaS: 2</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;maxIterations: 100</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;minNonDecreasing: 3</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;decay: 0.1</div></div><!-- fragment --><ul>
<li><code>sigmaE</code>: Scale parameter of the ARAP shape prior energy term (defaults to 5.4). Note that due to a slightly different implementation, the parameter is not exactly like in the paper. If <div class="image">
<img src="images/sigmaE.gif"  alt="sigmaE"/>
</div>
 is original parameter from the paper, then <div class="image">
<img src="images/sigmaE-equation.gif"  alt="\tilde{sigma_E} := \sigma_E \sqrt{\exp(\sigma_E)}"/>
</div>
 is the equivalent parameter for this implementation. So to reproduce the <div class="image">
<img src="images/sigmaE.gif"  alt="sigmaE"/>
</div>
 = 2 from the paper, you have to set <div class="image">
<img src="images/sigmaE-tilde.gif"  alt="\tilde{sigma_E}"/>
</div>
 = 5.4.</li>
<li><code>sigmaS</code>: Displacement prior scale parameter, defaults to 2 (see paper).</li>
<li><code>maxIterations</code>: Maximum number of iterations, defaults to 100.</li>
<li><code>minNonDecreasing</code>: Minimum number of iterations before entering decay mode, defaults to 10</li>
<li><code>decay</code>: Decay factor used in decay mode, defaults to 0.9.</li>
</ul>
<h5>Decay Mode</h5>
<p>Since an approximate alternating optimization scheme is used, it might happen, that the optimizer oscillates between two solutions and never completely converges. To circumvent this oscillation, the mean absolute displacement is monitored. Everytime it doesn't decrease for at least <code>minNonDecreasing</code> iterations, the current <code>sigmaS</code> is multiplied by <code>decay</code>, resulting in a decay of step size over time, enforcing convergence.</p>
<h2>Performance</h2>
<p>This implementation is, opposed to the original prototype underlying the publication, highly optimized. While the original prototype required a few minutes for about 50 iterations, this implementation can make 50 iterations in about 20 seconds (on an Intel(R) Core(TM) i7-8700K CPU @ 3.70GHz).</p>
<p>The optimization time does of course depends on the size of the model and the scans. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
